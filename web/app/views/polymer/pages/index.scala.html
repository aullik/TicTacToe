<link rel="import" href="@routes.Assets.at("bower_components/polymer/polymer.html")">
<link rel="import" href="@routes.Application.polymer("pages.sharedStyles")">

<dom-module id="my-index">

    <template>
        <style include="shared-styles">
        :host {
            display: block;

            padding: 10px;
        }

        .content {
            height: 80%;
            float: left;
        }

        .paddingCenter {

            padding: 11px;
            text-align: center;
        }

        paper-button.green {
            background-color: var(--paper-green-500);
            color: white;
        }

        .heading {
            height: 100%;
            width: calc(100% - 70px);
            text-align: center;
            float: left;
            display: flex;
        }

        .imageDiv img {
            width: 60px;
            height: 100%;
            float: left;
        }

        .imageDiv {
            width: calc(100% - 40px);
            height: 60px;
            float: left;
        }

        .heading span {
            margin: auto;
        }

        #usersCard {
            width: 240px;
            margin-left: 3px;
        }

        .actions {
            float: left;
            width: 40px;
            height: 60px;
            display: flex;
        }

        .usersContainerDiv {
            height: 100%;
            margin: auto;
            overflow-y: auto;
            width: 95%;
        }
        .disableClick{
            pointer-events:none;
        }
        </style>

            <!--my-socket id="socketIO" server="http://localhost:3000/"></my-socket>-->
        <iron-ajax id="userAjax"
        url="@routes.Application.getUsers()"
        method="POST"
        handle-as="json"
        on-response="handleUsrResponse"
        debounce-duration="300"></iron-ajax>
        <paper-card class="content" style="width: 60%;
            margin-left: 5%;
            display: flex">
            <div class="usersContainerDiv" id="usersContDiv">
                <h3>Users</h3>
                <template is="dom-repeat" items="{{users}}" as="user">
                    <paper-card id="usersCard">
                        <div class="imageDiv">
                            <img src="http://placehold.it/50/{{ getRandomColor() }}/fff&text={{getFirstChart(user.name)}}" alt="User Avatar">
                            <div class="heading"><span>{{ user.name }}</span></div>
                        </div>
                        <div class="actions">
                            <paper-icon-button id="{{ user.token }}" title="Start Game" on-click="_startGameOnClick" style="margin: auto" icon="hardware:videogame-asset"></paper-icon-button>
                        </div>
                    </paper-card>
                </template>
                <paper-toast id="callToast" text=""></paper-toast>
                <paper-dialog id="activatePaperSpinner" no-cancel-on-esc-key no-cancel-on-outside-click>
                    <h5>Calling...</h5>
                    <p><paper-spinner active id="spinner"></paper-spinner></p>
                </paper-dialog>
            </div>
        </paper-card>
        <div class="content" style="width: 25%">
            <div class="panel panel-primary" style=" height: 100%;
                border-radius: 0 4px 4px 0;
            ">
                <div class="panel-heading" id="accordion">
                    <i class="fa fa-commenting-o" aria-hidden="true"></i> Chat
                </div>
                <div class="panel-collapse" style="height: calc(100% - 103px);">
                    <div class="panel-body">
                        <ul class="chat">
                            <li class="left clearfix"><span class="chat-img pull-left">
                                <img src="http://placehold.it/50/55C1E7/fff&text=U" alt="User Avatar" class="img-circle" />
                            </span>
                                <div class="chat-body clearfix">
                                    <div class="header">
                                        <strong class="primary-font">
                  User</strong> <small class="pull-right text-muted">
                                        <span class="glyphicon glyphicon-time"></span>date</small>
                                    </div>
                                    <p>
                  text
                                    </p>
                                </div>
                            </li>
                            <li class="right clearfix"><span class="chat-img pull-right">
                                <img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar" class="img-circle" />
                            </span>
                                <div class="chat-body clearfix">
                                    <div class="header">
                                        <small class=" text-muted"><span class="glyphicon glyphicon-time"></span>
                                            date</small>
                                        <strong class="pull-right primary-font">USER</strong>
                                    </div>
                                    <p>
                  text
                                    </p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <input id="btn-input" type="text" class="form-control input-sm" placeholder="Type your message here..." />
                            <span class="input-group-btn">
                                <button class="btn btn-warning btn-sm" id="btn-chat">
                Send</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <paper-dialog id="paperDialogAnimated" no-cancel-on-esc-key no-cancel-on-outside-click>
            <h2 id="callRequestTitle">{{ modalTitle }}</h2>
            <div class="buttons">
                <paper-button raised raised  id="denyCall">deny</paper-button>
                <paper-button raised  id="acceptCall">accept</paper-button>
            </div>
        </paper-dialog>
        <a style="display: none" id="redirect" href='@routes.Application.game()'></a>
    </template>

    <script>
        // Let the library know where WebSocketMain.swf is:
        WEB_SOCKET_SWF_LOCATION = "/javascript/WebSocketMain.swf";

        Polymer({
        is: 'my-index',
        listeners: {
            'denyCall.tap': '_denyCall',
            'acceptCall.tap': '_acceptCall',
        },
        properties: {
            users: {
                type: Array,
                value: []
            },
            username: {
                type: String,
                value: ""
            },
            token: {
                type: String,
                value: ""
            },
            socket: {
                type: Object,
                observer: 'webSocketChanged'
            },
            modalTitle: String,
            otherToken: String
        },
        ready: function () {
            this.$.userAjax.generateRequest();
            this.socket = new WebSocket("ws://" + window.location.host + "/socket/");
        },
        webSocketChanged: function () {
            this.socket.onmessage = this.onMessage.bind(this);
            this.socket.onopen = this.onOpen.bind(this);
            this.socket.onerror = this.onError.bind(this);
            this.socket.onclose = this.onClose.bind(this);
        },
        onMessage: function (event) {
            var msg = JSON.parse(event.data);
            switch (msg.msgType) {
                case "call":
                    this.handleCall(msg.action);
                    break;
                case 'denyCall':
                    this.handleDenyCall(msg.action);
                    break;
                case 'acceptCall':
                    this.handleAcceptCall(msg.action);
                    break;
                case 'callAccepted':
                    this.handleCallAccepted(msg.action);
                    break;
                case 'newUser':
                    this.handleNewUser(msg.action);
                    break;
                default:
                    console.warn("Could not handle this message: " + msg);
            }
        },
        handleNewUser: function(data) {
            if(data.name && data.token){
                this.users.push(data);
            }
        },
        handleCall: function(data) {
            var user = users.find(x => x.token == data);
            if(user){
                this.modalTitle = "Call to start a game with " + user.name;
                this.otherToken = user.token;
                this.$.paperDialogAnimated.open()
            }
        },
        handleDenyCall: function(data) {
            alert("call denied")
            this.$.activatePaperSpinner.close();
            this.$.usersContDiv.classList.remove('disableClick')
        },
        handleAcceptCall: function(data) {
            this.socket.send({
                msgType:'callAccepted',
                action : data
            });
            this.$.activatePaperSpinner.close();
            this.$.usersContDiv.classList.remove('disableClick')
            this.$.redirect.click();
        },
        handleCallAccepted: function(data) {
            this.$.redirect.click();
        },
        onOpen: function (event) {
            console.log('Socket opened')
        },

        onError: function (event) {
            console.error("Error: " + event.reason);
        },

        onClose: function (event) {
            console.log("Web socket closed");
        },
        handleUsrResponse: function (e) {
            data = {
                name: "alice",
                token: "alicetoken",
                users: [{
                    name: "spieler1",
                    token: "asdf"
                },{
                    name: "spieler2",
                    token: "fjosid"
                }]
            }
            this.users = data.users;
            this.username = data.name;
            this.token = data.token;
            //console.log(data)
        },
        _startGameOnClick: function (event) {
            var id = event.srcElement.id;
            if (id === 'icon') id = event.srcElement.parentElement.id;
            this.socket.send({
                msgType:'call',
                action : id
            });
            this.$.callToast.text = "call has been sent";
            this.$.callToast.open();
            this.$.usersContDiv.classList.add('disableClick')
            this.$.activatePaperSpinner.open();
        },
        _denyCall: function (event) {
            this.$.paperDialogAnimated.close()
            var token = this.otherToken
            this.socket.send({
                msgType:'denyCall',
                action : token
            })
        },
        _acceptCall: function () {
            this.$.paperDialogAnimated.close()
            var token = this.otherToken
            this.socket.send({
                msgType:'acceptCall',
                action : token
            })
        },
        getRandomColor: function() {
            var letters = '0123456789ABCDEF';
            var color = '';
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        },
        getFirstChart: function(user){
            return user.charAt(0);
        }
    });
  </script>
</dom-module>
